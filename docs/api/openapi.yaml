# Wafaa AI Concierge - API Specification
#
# Full interactive documentation available at http://localhost:8000/docs (Swagger UI)
# or http://localhost:8000/redoc (ReDoc) when the backend is running.
#
# This file provides a high-level summary of all API endpoints.
# The authoritative OpenAPI JSON is auto-generated by FastAPI at /openapi.json.

openapi: "3.1.0"
info:
  title: Wafaa AI Concierge API
  version: "0.1.0"
  description: |
    Multi-tenant AI Concierge platform API.
    All protected endpoints require a Bearer JWT token obtained via POST /api/v1/auth/login.
    Webhook endpoints use HMAC-SHA256 signature verification instead of JWT.

servers:
  - url: http://localhost:8000
    description: Local development

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token from POST /api/v1/auth/login

paths:
  # ── Health ──────────────────────────────────────────────
  /health:
    get:
      summary: Root health check
      tags: [health]

  /api/v1/health:
    get:
      summary: API health check
      tags: [health]

  /api/v1/health/db:
    get:
      summary: Database connectivity check
      tags: [health]

  # ── Authentication ──────────────────────────────────────
  /api/v1/auth/login:
    post:
      summary: Authenticate and receive JWT tokens
      tags: [auth]

  /api/v1/auth/refresh:
    post:
      summary: Exchange refresh token for new access token
      tags: [auth]

  /api/v1/auth/me:
    get:
      summary: Get current authenticated user info
      tags: [auth]
      security:
        - BearerAuth: []

  /api/v1/auth/logout:
    post:
      summary: Invalidate current access token
      tags: [auth]
      security:
        - BearerAuth: []

  # ── Tenants ─────────────────────────────────────────────
  /api/v1/tenants/me:
    get:
      summary: Get current tenant info
      tags: [tenants]
      security:
        - BearerAuth: []
    patch:
      summary: Update tenant settings
      tags: [tenants]
      security:
        - BearerAuth: []

  /api/v1/tenants/me/admins:
    get:
      summary: List tenant admins
      tags: [tenants]
      security:
        - BearerAuth: []
    post:
      summary: Create a new tenant admin
      tags: [tenants]
      security:
        - BearerAuth: []

  # ── Knowledge Base ──────────────────────────────────────
  /api/v1/knowledge:
    post:
      summary: Upload a document to knowledge base
      tags: [knowledge]
      security:
        - BearerAuth: []
    get:
      summary: List tenant's knowledge documents
      tags: [knowledge]
      security:
        - BearerAuth: []

  /api/v1/knowledge/{document_id}:
    get:
      summary: Get document details
      tags: [knowledge]
      security:
        - BearerAuth: []
    delete:
      summary: Delete document and its chunks/vectors
      tags: [knowledge]
      security:
        - BearerAuth: []

  /api/v1/knowledge/{document_id}/reprocess:
    post:
      summary: Re-run document processing
      tags: [knowledge]
      security:
        - BearerAuth: []

  # ── Chat ────────────────────────────────────────────────
  /api/v1/chat:
    post:
      summary: Send message and get RAG-powered response
      tags: [chat]
      security:
        - BearerAuth: []

  # ── Channels ────────────────────────────────────────────
  /api/v1/channels:
    get:
      summary: List tenant's channels
      tags: [channels]
      security:
        - BearerAuth: []
    post:
      summary: Create a new channel
      tags: [channels]
      security:
        - BearerAuth: []

  /api/v1/channels/{channel_id}:
    get:
      summary: Get channel details
      tags: [channels]
      security:
        - BearerAuth: []
    patch:
      summary: Update channel configuration
      tags: [channels]
      security:
        - BearerAuth: []
    delete:
      summary: Delete channel and conversations
      tags: [channels]
      security:
        - BearerAuth: []

  # ── Conversations ───────────────────────────────────────
  /api/v1/conversations:
    get:
      summary: List tenant's conversations
      tags: [conversations]
      security:
        - BearerAuth: []

  /api/v1/conversations/{conversation_id}:
    get:
      summary: Get conversation with messages
      tags: [conversations]
      security:
        - BearerAuth: []

  # ── Analytics ───────────────────────────────────────────
  /api/v1/analytics/overview:
    get:
      summary: Get high-level metrics overview
      tags: [analytics]
      security:
        - BearerAuth: []

  /api/v1/analytics/conversations:
    get:
      summary: Get conversation trends
      tags: [analytics]
      security:
        - BearerAuth: []

  /api/v1/analytics/messages:
    get:
      summary: Get message volume trends
      tags: [analytics]
      security:
        - BearerAuth: []

  /api/v1/analytics/channels:
    get:
      summary: Get per-channel performance metrics
      tags: [analytics]
      security:
        - BearerAuth: []

  # ── Agent Analytics ─────────────────────────────────────
  /api/v1/analytics/agent/sentiment:
    get:
      summary: Get sentiment distribution
      tags: [agent-analytics]
      security:
        - BearerAuth: []

  /api/v1/analytics/agent/response-time:
    get:
      summary: Get response time metrics and trends
      tags: [agent-analytics]
      security:
        - BearerAuth: []

  /api/v1/analytics/agent/conversations:
    get:
      summary: Get conversation length analytics
      tags: [agent-analytics]
      security:
        - BearerAuth: []

  /api/v1/analytics/agent/insights:
    get:
      summary: Get AI-generated insights
      tags: [agent-analytics]
      security:
        - BearerAuth: []

  # ── Webhooks (public, HMAC-protected) ───────────────────
  /api/v1/webhooks/whatsapp:
    get:
      summary: WhatsApp webhook verification (hub.challenge)
      tags: [webhooks]
    post:
      summary: Receive WhatsApp messages
      tags: [webhooks]

  /api/v1/webhooks/instagram:
    get:
      summary: Instagram webhook verification (hub.challenge)
      tags: [webhooks]
    post:
      summary: Receive Instagram messages
      tags: [webhooks]
